{% extends 'strona_glowna.html' %}

{% block content %}
<div class="product-container">

    <div class="product-card-frame">
        <img src="{{ url_for('static', filename='images/products/' + zdjecie) }}" alt="Zdjecie produktu" class="product-image">
        <p class="product-name-inside">{{ nazwa }}</p>
    </div>

    <div class="guess-counter" id="guess-counter">
        Guess: 1/6
    </div>

    <div class="rectangle-list" id="guess-list" style="position: relative;">
        <div id="invalid-popup" class="invalid-popup" style="display: none;"> Niepoprawna warto≈õƒá!</div>
        <div class="rectangle"></div>
        <div class="rectangle"></div>
        <div class="rectangle"></div>
        <div class="rectangle"></div>
        <div class="rectangle"></div>
        <div class="rectangle"></div>
    </div>

    <div class="input-container">
        <input type="text" class="amount-input" placeholder="Wpisz kwotƒô..." id="guess-input">
        <button class="guess-button" onclick="submitGuess()">Odgadnij</button>
    </div>

</div>

  
<script>
document.addEventListener("DOMContentLoaded", () => {
    const inputField = document.querySelector('.amount-input');
    const guessButton = document.querySelector('.guess-button');
    const rectangleList = document.querySelectorAll('.rectangle');
    const guessCounter = document.getElementById('guess-counter');
    const productFrame = document.querySelector('.product-card-frame');
    const correctPrice = {{ cena }};

    // üîÅ Codzienny reset lokalnych danych
    const today = new Date().toDateString();
    const storedDay = localStorage.getItem('day');
    if (storedDay !== today) {
        localStorage.clear();
        localStorage.setItem('day', today);
    }

    // üîÑ Przywracanie poprzednich pr√≥b
    let guesses = JSON.parse(localStorage.getItem('guesses')) || [];
    let currentTry = guesses.length + 1;
    let remainingTries = rectangleList.length - guesses.length;

    guesses.forEach((guess, index) => {
        const rectangle = rectangleList[index];
        rectangle.textContent = guess.text;
        rectangle.style.backgroundColor = guess.color;
    });

    guessCounter.textContent = `Guess: ${currentTry}/${rectangleList.length}`;

    // üéØ Walidacja pola
    inputField.addEventListener('input', () => {
        inputField.value = inputField.value.replace(/[^0-9.,]/g, '');
    });

    const handleGuess = () => {
        let userPrice = inputField.value.replace(',', '.');
        userPrice = parseFloat(userPrice);

        if (isNaN(userPrice)) {
            const popup = document.getElementById('invalid-popup');
            popup.style.display = "block";
            popup.classList.add("flip");
            popup.addEventListener('animationend', () => {
                popup.classList.remove("flip");
            }, { once: true });
            setTimeout(() => {
                popup.style.display = "none";
            }, 2000);
            return;
        }

        fetch('/check_price', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ price: userPrice, correct_price: correctPrice, remaining_tries: remainingTries })
        })
        .then(response => response.json())
        .then(data => {
            const { difference, direction, game_status } = data;

            if (game_status !== "win" && game_status !== "lose") {
                productFrame.classList.add('shake');
                productFrame.addEventListener('animationend', () => {
                    productFrame.classList.remove('shake');
                }, { once: true });
            }

            if (currentTry <= rectangleList.length) {
                const rectangle = rectangleList[currentTry - 1];
                let color = "red";
                let text = `${userPrice.toFixed(2)} z≈Ç ${direction === 'down' ? '‚Üì' : '‚Üë'}`;

                if (difference < 0.10) {
                    color = "green";
                    text = `${userPrice.toFixed(2)} z≈Ç ‚úì`;
                } else if (difference <= 2) {
                    color = "yellow";
                }

                rectangle.textContent = text;
                rectangle.style.backgroundColor = color;
                rectangle.classList.add('flip');
                rectangle.addEventListener('animationend', () => {
                    rectangle.classList.remove('flip');
                }, { once: true });

                // üíæ Zapisz do localStorage
                guesses.push({ text, color });
                localStorage.setItem('guesses', JSON.stringify(guesses));

                currentTry++;
                remainingTries--;
            }

            if (game_status === "win") {
                inputField.style.display = "none";
                guessButton.style.display = "none";
                guessCounter.innerHTML = `üéâ Wygra≈Çe≈õ! Gratulacje!<br>Cena: ${correctPrice.toFixed(2)} z≈Ç`;
                guessCounter.style.color = "green";
            } else if (game_status === "lose") {
                inputField.style.display = "none";
                guessButton.style.display = "none";
                guessCounter.innerHTML = `‚ùå Przegra≈Çe≈õ!<br>Cena: ${correctPrice.toFixed(2)} z≈Ç`;
                guessCounter.style.color = "red";
            } else {
                guessCounter.textContent = `Guess: ${currentTry}/${rectangleList.length}`;
            }

            inputField.value = '';
        })
        .catch(error => console.error('Error:', error));
    };

    guessButton.addEventListener('click', handleGuess);
    inputField.addEventListener('keydown', (event) => {
        if (event.key === 'Enter') handleGuess();
    });
});
</script>
{% endblock %}
