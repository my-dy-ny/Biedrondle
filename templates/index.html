{% extends 'base.html' %}

{% block content %}
<div class="product-container">

    <div class="product-card-frame">
        <img src="{{ url_for('static', filename='images/products/' + zdjecie) }}" alt="Zdjecie produktu" class="product-image">
        <p class="product-name-inside">{{ nazwa }}</p>
    </div>

    <div class="guess-counter" id="guess-counter">
        Guess: 1/6
    </div>

    <div class="rectangle-list" id="guess-list" style="position: relative;">
        <div id="invalid-popup" class="invalid-popup" style="display: none;"> Niepoprawna warto≈õƒá!</div>
        
        <div class="rectangle"></div>
        <div class="rectangle"></div>
        <div class="rectangle"></div>
        <div class="rectangle"></div>
        <div class="rectangle"></div>
        <div class="rectangle"></div>
    </div>

    <div class="input-container">
        <input type="text" class="amount-input" placeholder="Wpisz kwotƒô..." id="guess-input">
        <button class="guess-button" onclick="submitGuess()">Odgadnij</button>
    </div>

</div>

  </div>
  
  <script>
      document.addEventListener("DOMContentLoaded", () => {
          const inputField = document.querySelector('.amount-input');
          inputField.addEventListener('input', () => {
              // Tylko cyfry, kropki i przecinki
              inputField.value = inputField.value.replace(/[^0-9.,]/g, '');
          });
  
          const guessButton = document.querySelector('.guess-button');
          const rectangleList = document.querySelectorAll('.rectangle');
          const messageContainer = document.createElement('div');
          const productContainer = document.querySelector('.product-container');
          const guessCounter = document.getElementById('guess-counter');
          const correctPrice = {{ cena }};
          let remainingTries = rectangleList.length;
          let currentTry = 1; // Rozpoczynamy od 1, ≈ºeby by≈Ço Guess: 1/6
  
          // Przygotowanie kontenera na wiadomo≈õci
          messageContainer.className = "message-container";
          messageContainer.style.marginTop = "20px";
          messageContainer.style.fontSize = "1.2rem";
          productContainer.appendChild(messageContainer);
  
          // Ustawiamy od razu Guess 1/6
          guessCounter.textContent = `Guess: 1/${rectangleList.length}`;
  
          inputField.value = '';
  
          const handleGuess = () => {
              let userPrice = inputField.value.replace(',', '.');
              userPrice = parseFloat(userPrice);
  
              if (isNaN(userPrice)) {
                  const popup = document.getElementById('invalid-popup');
                  popup.style.display = "block";
                  popup.classList.add("flip");
  
                  // usu≈Ñ klasƒô shake po animacji
                  popup.addEventListener('animationend', () => {
                      popup.classList.remove("flip");
                  }, { once: true });
  
                  // schowaj po 2 sekundach
                  setTimeout(() => {
                      popup.style.display = "none";
                  }, 2000);
  
                  return;
              }
  
              fetch('/check_price', {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({ price: userPrice, correct_price: correctPrice, remaining_tries: remainingTries })
              })
              .then(response => response.json())
              .then(data => {
                  const { difference, direction, game_status } = data;
                  const productFrame = document.querySelector('.product-card-frame');
  
                  // Je≈õli odpowied≈∫ b≈Çƒôdna (czyli NIE wygrana ani przegrana)
                  if (game_status !== "win" && game_status !== "lose") {
                      productFrame.classList.add('shake');
  
                      // Usuwamy klasƒô shake po zako≈Ñczeniu animacji (≈ºeby mo≈ºna by≈Ço trzƒÖ≈õƒá wielokrotnie)
                      productFrame.addEventListener('animationend', () => {
                          productFrame.classList.remove('shake');
                      }, { once: true });
                  }
  
                  if (currentTry <= rectangleList.length) {
                      const rectangle = rectangleList[currentTry - 1]; // Pobieramy odpowiedni prostokƒÖt
  
                      rectangle.textContent = `${userPrice.toFixed(2)} z≈Ç ${direction === 'down' ? '‚Üì' : '‚Üë'}`;
  
                      // Animacja flip-up dla prostokƒÖta
                      rectangle.classList.add('flip');
                      rectangle.addEventListener('animationend', () => {
                          rectangle.classList.remove('flip');
                      }, { once: true });
  
                      // Kolorowanie prostokƒÖta w zale≈ºno≈õci od trafno≈õci ceny
                      if (difference < 0.10) {
                          rectangle.style.backgroundColor = "green";
                          rectangle.textContent = `${userPrice.toFixed(2)} z≈Ç ‚úì`;
                      } else if (difference <= 2) {
                          rectangle.style.backgroundColor = "yellow";
                          rectangle.textContent = `${userPrice.toFixed(2)} z≈Ç ${direction === 'down' ? '‚Üì' : '‚Üë'}`;
                      } else {
                          rectangle.style.backgroundColor = "red";
                          rectangle.textContent = `${userPrice.toFixed(2)} z≈Ç ${direction === 'down' ? '‚Üì' : '‚Üë'}`;
                      }
  
                      currentTry++;
                  }
  
                  // Aktualizacja licznika pr√≥b
                  guessCounter.textContent = `Guess: ${currentTry}/${rectangleList.length}`;
  
                  if (game_status === "win") {
                      // Obs≈Çuga wygranej
                      inputField.style.display = "none";
                      guessButton.style.display = "none";
                      guessCounter.innerHTML = `üéâ Wygra≈Çe≈õ! Gratulacje!<br>Cena: ${correctPrice.toFixed(2)} z≈Ç`;
                      guessCounter.style.color = "green";
                  } else if (game_status === "lose") {
                      // Obs≈Çuga przegranej
                      inputField.style.display = "none";
                      guessButton.style.display = "none";
                      guessCounter.innerHTML = `‚ùå Przegra≈Çe≈õ!<br>Cena: ${correctPrice.toFixed(2)} z≈Ç`;
                      guessCounter.style.color = "red";
                  } else {
                      // Je≈õli gra nadal trwa
                      guessCounter.textContent = `Guess: ${currentTry}/${rectangleList.length}`;
                  }
  
                  remainingTries--;
                  inputField.value = '';
              })
              .catch(error => console.error('Error:', error));
          };
  
          // Obs≈Çuga klikniƒôcia przycisku "Odgadnij"
          guessButton.addEventListener('click', handleGuess);
  
          // Obs≈Çuga klawisza Enter w polu input
          inputField.addEventListener('keydown', (event) => {
              if (event.key === 'Enter') {
                  handleGuess();
              }
          });
      });
  </script>
{% endblock %}
